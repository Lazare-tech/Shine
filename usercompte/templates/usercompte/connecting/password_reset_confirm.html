{% extends "base.html" %}
{% block content %}
<section class="container py-5 d-flex align-items-center justify-content-center min-vh-100">
    <div class="shine-card shadow-lg p-4 p-md-5 rounded-4 border-0 position-relative overflow-hidden" style="max-width: 480px; background: #fff;">
        
        <div class="position-absolute top-0 start-0 w-100 h-2 bg-gold" style="height: 5px; background-color: #B8860B;"></div>

        <div class="text-center mb-4">
            <div class="icon-circle mb-3 mx-auto shadow-sm" style="width: 60px; height: 60px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                <i class="fas fa-shield-alt text-gold" style="color: #B8860B; font-size: 1.5rem;"></i>
            </div>
            <h3 class="fw-bold text-navy">Sécurisez votre compte</h3>
            <p class="text-muted small">Saisissez et confirmez votre nouveau mot de passe ci-dessous.</p>
        </div>

        {% if validlink %}
            <form method="POST" class="needs-validation" novalidate>
                {% csrf_token %}
                
                {% for field in form %}
                    <div class="mb-3">
                        <label for="{{ field.id_for_label }}" class="form-label small fw-bold text-navy mb-1">
                            {{ field.label }}
                        </label>
                        
                        {# On injecte dynamiquement la classe form-control de Bootstrap #}
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0 text-muted">
                                <i class="fas fa-lock small"></i>
                            </span>
                            <input type="{{ field.field.widget.input_type }}" 
                                   name="{{ field.name }}" 
                                   id="{{ field.id_for_label }}"
                                   autocomplete="new-password"
                                   class="form-control border-start-0 ps-0 {% if field.errors %}is-invalid{% endif %}"
                                   placeholder="••••••••"
                                   required>
                            
                            {% if field.errors %}
                                <div class="invalid-feedback d-block fw-semibold" style="font-size: 0.75rem;">
                                    {{ field.errors|striptags }}
                                </div>
                            {% endif %}
                        </div>
                        
                        {% if field.help_text %}
                            <div class="form-text extra-small text-muted mt-1" style="font-size: 0.7rem;">
                                {{ field.help_text|safe }}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}

                <button type="submit" id="btn-submit" class="btn btn-navy w-100 py-3 rounded-pill fw-bold shadow-gold mt-3 transition-hover">
                    <span class="btn-text">Mettre à jour le mot de passe</span>
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                </button>
            </form>
        {% else %}
            <div class="alert alert-soft-danger text-center p-4 rounded-3 border-0" style="background-color: rgba(220, 53, 69, 0.1);">
                <i class="fas fa-exclamation-triangle mb-3 d-block fs-2 text-danger"></i>
                <h5 class="fw-bold text-danger">Lien expiré ou invalide</h5>
                <p class="text-muted small mb-4">Pour des raisons de sécurité, les liens de réinitialisation ne sont valables qu'une seule fois.</p>
                <a href="{% url 'usercompte:password_reset' %}" class="btn btn-navy btn-sm px-4 rounded-pill">
                    Demander un nouveau lien
                </a>
            </div>
        {% endif %}
    </div>
</section>

<script>
    // Petit script UX pour montrer un chargement au clic
    document.querySelector('form')?.addEventListener('submit', function() {
        const btn = document.getElementById('btn-submit');
        btn.querySelector('.btn-text').classList.add('d-none');
        btn.querySelector('.spinner-border').classList.remove('d-none');
        btn.classList.add('disabled');
    });
</script>

<style>
    .text-navy { color: #122046; }
    .btn-navy { background-color: #122046; color: white; border: none; transition: 0.3s; }
    .btn-navy:hover { background-color: #B8860B; color: white; transform: translateY(-2px); }
    .form-control:focus { border-color: #B8860B; box-shadow: 0 0 0 0.25rem rgba(184, 134, 11, 0.1); }
    .shadow-gold { box-shadow: 0 4px 15px rgba(18, 32, 70, 0.15); }
</style>
{% endblock %}